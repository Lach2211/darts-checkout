<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#111"/>
<title>Darts Checkout Rechner (PWA)</title>
<link rel="manifest" href="manifest.json">
<style>
  :root{
    --bg:#0e0e10; --bg2:#121216; --bg3:#18181d; --line:#26262b; --line2:#2c2c33;
    --text:#eee; --muted:#aab; --accent:#20d64a; --accent2:#ffd54a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
  .app{min-height:100vh;display:flex;flex-direction:column}

  .bar{display:grid;gap:.5rem;grid-template-columns:repeat(3,minmax(0,1fr));
    padding:.75rem;background:#16161a;position:sticky;top:0;z-index:5;border-bottom:1px solid var(--line)}
  .mode-btn{padding:.65rem .8rem;border:1px solid #333;background:#1f1f24;color:#ddd;border-radius:.6rem;font-weight:700;cursor:pointer}
  .mode-btn.active{outline:2px solid #ff5252;outline-offset:2px}

  .main{display:grid;grid-template-columns:1fr 1fr;gap:0;min-height:0;flex:1}
  @media (max-width:920px){.main{grid-template-columns:1fr}}

  .fav-wrap{display:grid;gap:.5rem;grid-template-columns:repeat(6,minmax(0,1fr));
    padding:.6rem .75rem .4rem;background:var(--bg2);border-bottom:1px solid var(--line)}
  .fav-btn{padding:.5rem .4rem;border:2px solid #2a2a2f;background:#18181d;color:#eaeaea;border-radius:.6rem;
    font-weight:800;cursor:pointer;text-align:center;letter-spacing:.3px;user-select:none}
  .fav-btn[data-rank="1"]{border-color:#20d64a;box-shadow:0 0 0 1px #20d64a55 inset}
  .fav-btn[data-rank="2"]{border-color:#ffd54a;box-shadow:0 0 0 1px #ffd54a55 inset}
  .fav-btn[data-rank="3"]{border-color:#ffffff;box-shadow:0 0 0 1px #ffffff55 inset}
  .fav-actions{display:flex;gap:.5rem;padding:0 .75rem .75rem;background:var(--bg2);align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--line)}
  .small-btn{padding:.45rem .65rem;border-radius:.5rem;border:1px solid #333;background:#1f1f24;color:#ddd;cursor:pointer}
  .muted{color:var(--muted);font-size:.9rem}

  .left{border-right:1px solid var(--line);display:flex;flex-direction:column;min-height:0}
  .grid{--tile-min:76px;padding:.75rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--tile-min),1fr));gap:.5rem;overflow:auto}
  .tile{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.9rem .4rem;
    background:#17171b;border:1px solid var(--line2);border-radius:.9rem;font-weight:900;user-select:none;cursor:pointer;color:#fff}
  .tile-label{font-size:.85rem;line-height:1;color:#c9c9cf;margin-bottom:.25rem;font-weight:700;text-align:center;opacity:.95}
  .tile-num{font-size:1.35rem;line-height:1}
  .tile:active{transform:scale(.985)}

  .right{display:flex;flex-direction:column;min-height:0}
  .results{padding:1rem;border-left:1px solid var(--line);background:var(--bg2);height:100%;overflow:auto}
  .results h2{margin:.25rem 0 1rem 0;font-size:2.2rem}
  .top3{display:grid;gap:.65rem}
  .res-card{padding:1rem;border:1px solid var(--line2);background:var(--bg3);border-radius:1rem;line-height:1.4}
  .res-card strong{font-size:2.2rem}
  .res-card .path{font-size:2rem;font-weight:900}
  .res-card.best{outline:3px solid var(--accent)}
  details.summarybox{margin-top:.6rem;border:1px dashed var(--line2);border-radius:.8rem;background:#0f0f12;padding:.6rem .75rem}
  details summary{cursor:pointer;font-weight:800;color:#ddd}
  .more{display:grid;gap:.5rem;margin-top:.5rem}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="bar">
    <button class="mode-btn" data-mode="DO">Double Out</button>
    <button class="mode-btn" data-mode="MO">Master Out</button>
    <button class="mode-btn" data-mode="SO">Straight Out</button>
  </div>

  <div class="fav-wrap" id="favWrap"></div>
  <div class="fav-actions">
    <span class="muted">Reihenfolge: 1 = <b style="color:#20d64a">grün</b>, 2 = <b style="color:#ffd54a">gelb</b>, 3 = <b style="color:#fff">weiß</b></span>
    <button class="small-btn" id="resetFavs">Auswahl zurücksetzen</button>
  </div>

  <div class="main">
    <div class="left">
      <div class="grid" id="scoreGrid" aria-live="polite"></div>
    </div>
    <div class="right">
      <div class="results" id="results" hidden>
        <h2>Checkout-Ergebnisse</h2>
        <div class="top3" id="top3"></div>
        <details class="summarybox" id="moreBox" hidden>
          <summary id="moreSummary">Alle weiteren Checkouts anzeigen</summary>
          <div id="moreList" class="more"></div>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Zustand ===== */
const bogeyDO = new Set([169,168,166,165,163,162,159]);
let mode = localStorage.getItem('mode') || 'DO';
let favorites = JSON.parse(localStorage.getItem('favorites')||'[]'); // ["D20","D18","D16","D25"]

/* ===== DOM ===== */
const btnsMode = [...document.querySelectorAll('.mode-btn')];
const scoreGrid = document.getElementById('scoreGrid');
const favWrap = document.getElementById('favWrap');
const resultsEl = document.getElementById('results');
const top3El = document.getElementById('top3');
const moreBox = document.getElementById('moreBox');
const moreList = document.getElementById('moreList');
const moreSummary = document.getElementById('moreSummary');
const resetFavsBtn = document.getElementById('resetFavs');

/* ===== Wurf-Pools ===== */
const make=(name,val)=>({name,val});
const DOUBLES = Array.from({length:20},(_,i)=>make(`D${i+1}`,2*(i+1))).concat([make('Bull',50)]);
const TRIPLES = Array.from({length:20},(_,i)=>make(`T${i+1}`,3*(i+1)));
const SINGLES = Array.from({length:20},(_,i)=>make(`S${i+1}`,(i+1))).concat([make('SB',25), make('Bull',50)]);
const POOL_ALL = [...TRIPLES, ...DOUBLES, ...SINGLES];

/* ===== Regeln ===== */
const allowedStartDoubles = new Set(['D20','D18','D16','D25','Bull']); // Start-Doppel erlaubt

const isFinishAllowed = last => {
  if(!last) return false;
  if (mode==='DO') return last.name.startsWith('D') || last.name==='Bull';
  if (mode==='MO') return last.name.startsWith('D') || last.name.startsWith('T') || last.name==='Bull';
  return true;
};

// Anzeige: D25 → Bull
const nameForDisplay = n => (n==='D25' || n==='Bull') ? 'Bull' : n;

/* Softener nur für die ersten ZWEI Würfe – NIEMALS den letzten verändern */
function softenFirstTwoExcludingLast(seq){
  const out=[...seq];
  const count = Math.min(2, Math.max(0, out.length-1)); // max 2, aber letzten nicht anfassen
  for (let i=0;i<count;i++){
    const t=out[i];
    if (t.name.startsWith('D')){
      const n=Number(t.name.slice(1));
      // Start-Doppel unzulässig? → verwerfen (durch Umwandlung in Single, falls möglich)
      if (i===0 && !allowedStartDoubles.has(t.name)){
        if (n>=1 && n<=10) out[i]=make(`S${2*n}`,2*n);
        else return null; // D11..D20 ungerade → keine Single-Entsprechung → Sequenz verwerfen
      }else{
        if (n>=1 && n<=10){ out[i]=make(`S${2*n}`,2*n); } // Doppel 1–10 als Single
      }
    }else if (t.name.startsWith('T')){
      const n=Number(t.name.slice(1));
      if (n>=1 && n<=6){ out[i]=make(`S${3*n}`,3*n); } // Triples 1–6 als Single
    }
  }
  return out;
}

/* Taktische Gültigkeit (nach deinen Regeln) */
function isTacticallyValid(seq){
  // Start-Doppel nur D20/D18/D16/Bull
  if (seq.length>=2 && seq[0].name.startsWith('D') && !allowedStartDoubles.has(seq[0].name)) return false;
  // „Triples 1–6“ im ersten/zweiten Dart vermeiden – wird ohnehin zu Single downgraded; gültig
  return true;
}

/* Kanonische Darstellung: weiche 1./2. Wurf ab, sortiere die ersten, letzter bleibt hinten */
function canonicalize(seq){
  const soft = softenFirstTwoExcludingLast(seq);
  if (!soft) return null; // Sequenz verworfen (z. B. Start D19)
  const firstTwo = soft.slice(0,soft.length-1).sort((a,b)=>b.val-a.val);
  const last = soft[soft.length-1];
  const arr = [...firstTwo, last];
  const asText = arr.map(t=>nameForDisplay(t.name)).join(' ');
  return {arr, text:asText};
}

/* Suche bis 3 Darts */
function findFinishes(target){
  const res = [];

  function dfs(darts, remaining, seq){
    if (darts===0){
      if (remaining===0 && isFinishAllowed(seq[seq.length-1]) && isTacticallyValid(seq)) res.push(seq);
      return;
    }
    if (darts===1){
      for (const t of POOL_ALL){
        if (t.val===remaining && isFinishAllowed(t)){
          const cand=[...seq,t];
          if (isTacticallyValid(cand)) res.push(cand);
        }
      }
      return;
    }
    for (const t of POOL_ALL){
      if (t.val>remaining) continue;
      dfs(darts-1, remaining-t.val, [...seq,t]);
    }
  }

  dfs(1,target,[]);
  dfs(2,target,[]);
  dfs(3,target,[]);

  // Duplikate entfernen, nach Kanonisierung
  const seen = new Set();
  const list = [];
  for (const seq of res){
    const canon = canonicalize(seq);
    if (!canon) continue;
    if (seen.has(canon.text)) continue;
    seen.add(canon.text);
    list.push({text:canon.text, seq});
  }
  return list;
}

/* Minimal-Dart-Anzahl */
const minCache = new Map();
function minDarts(score){
  const key = mode+':'+score;
  if (minCache.has(key)) return minCache.get(key);
  const r = findFinishes(score);
  let m = Infinity;
  for (const {seq} of r) m = Math.min(m, seq.length);
  minCache.set(key, m);
  return m;
}

/* ===== Lieblings-Doppel UI (ungerade Doppel entfernt) ===== */
const favItems = ["D10","D12","D14","D16","D18","D20","D25"]; // D25 ⇒ Bull
function renderFavButtons(){
  favWrap.innerHTML='';
  favItems.forEach(d=>{
    const b=document.createElement('button');
    b.className='fav-btn';
    b.textContent = (d==='D25'?'Bull':d);
    const rank=favorites.indexOf(d);
    if (rank!==-1) b.dataset.rank=(rank+1).toString();
    b.addEventListener('click',()=>toggleFavorite(d));
    favWrap.appendChild(b);
  });
}
function toggleFavorite(d){
  const idx=favorites.indexOf(d);
  if (idx>=0) favorites.splice(idx,1);
  else if (favorites.length<3) favorites.push(d);
  localStorage.setItem('favorites',JSON.stringify(favorites));
  renderFavButtons();
  if (currentScore!=null) showCheckouts(currentScore);
}
resetFavsBtn.addEventListener('click',()=>{
  favorites=[]; localStorage.setItem('favorites','[]'); renderFavButtons();
  if (currentScore!=null) showCheckouts(currentScore);
});

/* ===== Modus ===== */
btnsMode.forEach(b=>{
  b.addEventListener('click',()=>{
    mode=b.dataset.mode;
    localStorage.setItem('mode',mode);
    updateModeButtons();
    minCache.clear();
    renderScores();
    clearResults();
  });
});
function updateModeButtons(){
  btnsMode.forEach(b=>b.classList.toggle('active',b.dataset.mode===mode));
}

/* ===== Score-Grid ===== */
let currentScore=null;

function renderScores(){
  scoreGrid.innerHTML='';
  const range = (mode==='DO') ? {min:2,max:170} : {min:2,max:180};

  for (let s=range.max; s>=range.min; s--){
    if (mode==='DO' && bogeyDO.has(s)) continue;

    if (mode!=='DO'){
      const m=minDarts(s);
      if (m===Infinity || m>3) continue;
    }

    const tile=document.createElement('button');
    tile.className='tile';
    const m = minDarts(s);
    const label=document.createElement('div');
    label.className='tile-label';
    label.textContent = (m===1?'1 Dart': m===2?'2 Darts':'3 Darts');
    const num=document.createElement('div');
    num.className='tile-num';
    num.textContent=String(s);

    tile.appendChild(label);
    tile.appendChild(num);
    tile.addEventListener('click',()=>onScoreClick(s));
    scoreGrid.appendChild(tile);
  }
}

/* ===== Ergebnisse & Ranking ===== */
function clearResults(){
  resultsEl.hidden=true;
  top3El.innerHTML='';
  moreBox.hidden=true;
  moreList.innerHTML='';
}

function pickTopByFavorites(paths){
  if (!favorites.length) return paths.map(p=>p.text);
  const lastName = (text)=> {
    const last = text.split(' ').pop();
    return (last==='Bull') ? 'D25' : last;
  };
  const used = new Set();
  const top = [];
  for (const fav of favorites){
    const hit = paths.find(p => lastName(p.text)===fav && !used.has(p.text));
    if (hit){ top.push(hit.text); used.add(hit.text); }
  }
  for (const p of paths){
    if (top.length>=3) break;
    if (!used.has(p.text)){ top.push(p.text); used.add(p.text); }
  }
  return top;
}

function showCheckouts(s){
  const found = findFinishes(s);

  const sorted = [...found].sort((a,b)=>{
    if (a.seq.length !== b.seq.length) return a.seq.length - b.seq.length;
    const av = a.seq.slice(0,-1).reduce((x,t)=>x+t.val,0);
    const bv = b.seq.slice(0,-1).reduce((x,t)=>x+t.val,0);
    return bv-av;
  });

  const topThree = pickTopByFavorites(sorted).slice(0,3);
  const rest = sorted.map(p=>p.text).filter(t=>!topThree.includes(t));

  resultsEl.hidden=false;

  if (!sorted.length){
    top3El.innerHTML = `<div class="res-card">Kein Checkout gefunden.</div>`;
    moreBox.hidden=true;
    return;
  }

  top3El.innerHTML = topThree.map((t,i)=>`
    <div class="res-card ${i===0?'best':''}">
      <div><strong>${s}</strong> <span class="path">→ ${t}</span></div>
      ${i===0?'<div class="muted">Bester Vorschlag</div>':''}
    </div>
  `).join('');

  if (rest.length){
    moreSummary.textContent = `Alle weiteren Checkouts anzeigen (${rest.length})`;
    moreList.innerHTML = rest.map(t=>`<div class="res-card"><span class="path">${t}</span></div>`).join('');
    moreBox.hidden=false;
  }else{
    moreBox.hidden=true;
  }
}

/* ===== Events ===== */
function onScoreClick(s){ currentScore=s; showCheckouts(s); }

/* ===== Init ===== */
function init(){
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  }
  // Defaults, falls alte Favoriten noch „ungerade Doppel“ enthalten
  favorites = favorites.filter(f=>["D10","D12","D14","D16","D18","D20","D25"].includes(f));
  localStorage.setItem('favorites', JSON.stringify(favorites));
  updateModeButtons();
  renderFavButtons();
  renderScores();
  btnsMode.find(b=>b.dataset.mode===mode)?.classList.add('active');
}
init();
</script>
</body>
</html>
